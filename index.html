<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
    <script type="text/javascript" src="src/paths.js"></script>
</head>
<body>

    <script>
    var config = {
        type: Phaser.AUTO,
            width: 768,
            height: 369,
        scene: {
            preload: preload,   
            create: create,
            update: update
        }
    };

    var game = new Phaser.Game(config);

    function preload ()
    {
        // load images
        this.load.image('background', 'assets/background.jpg');
        this.load.image('diceButton', 'assets/dicebutton.jpg');
        this.load.image('truckButton', 'assets/buytruck.jpg');
        this.load.image('popup', 'assets/pop.jpg');
        this.load.image('close', 'assets/close.jpg');
        this.load.image('buggy', 'assets/buggy.png');
    }

    
    var movingBuggy = null;
    var diceRoll = 0;
    var diceRollText;
    function create ()
    {
        var money = 0;


        let bg = this.add.sprite(0, 0, 'background');
        bg.setScale(0.4);
        bg.setOrigin(0,0);

        // Add the roll dice button
        diceRollText = this.add.text(740, 41, '', { fontSize: '8px', fill: '#fff' });
        var rollDice = this.add.sprite(700, 46, 'diceButton').setInteractive();
        rollDice.setScale(0.3);
        rollDice.on('pointerdown', function (pointer) {
            this.setTint(0xff0000);
        });
        rollDice.on('pointerup', function (pointer) {
            this.clearTint();
            diceRoll = Math.floor(Math.random() * 6) + 1;
            diceRollText.setText(diceRoll);
        });

        // Add the truck buying button
        var truckNo = 6;
        var truckNoText = this.add.text(740, 21, truckNo, { fontSize: '8px', fill: '#fff' });
        var buyTruck = this.add.sprite(700, 26, 'truckButton').setInteractive();
        buyTruck.setScale(0.3);
        buyTruck.on('pointerdown', function (pointer) {
            this.setTint(0xff0000);
        });
        buyTruck.on('pointerup', function (pointer) {
            buyTruck.clearTint();
            if(truckNo != 0) {
                truckNo = truckNo - 1;
                truckNoText.setText(truckNo);
                truckNoText.clearTint();

                // make a truck that has been bought
                var buggy = new Buggy({scene:this, x:redMine.x, y:redMine.y}, redMine);
            } else {
                truckNoText.setTint(0xff0000);
            }
        }.bind(this));
        
        // Iterate through each path and draw lines
        graphics = this.add.graphics();
        drawPath(pinkMine);
        drawPath(greenMine);
        drawPath(purpleMine);
        drawPath(blueMine);
        drawPath(redMine);
        drawPath(yellowMine);
    }

    // Iterative function for looping through a path
    function traversePath(node, accumulator, stopValue) {
        node.neighbours.forEach(neighbour => {
            if(accumulator != stopValue) {
                traversePath(neighbour, accumulator + 1, stopValue);
            } else {
                graphics.fillStyle(0x000, 1);
                graphics.fillCircle(neighbour.x, neighbour.y, 2);
            }
        });
    }

    function update() {
        // Record player mouse location if they can move the buggy move the buggy to the closest location
        this.input.on('pointerup', function (pointer) {
            if(movingBuggy) {
                selectPath(movingBuggy.location, 1, diceRoll, pointer.position, clickedNode => {
                    movingBuggy.x = clickedNode.x;
                    movingBuggy.y = clickedNode.y;
                    movingBuggy.location = clickedNode;
                    diceRoll = 0;
                    diceRollText.setText('');
                    movingBuggy.clearTint();
                    movingBuggy = null;

                    
                });
            }
        });
    }

    function selectPath(node, accumulator, stopValue, position, cb) {
        node.neighbours.forEach(neighbour => {
            if(accumulator != stopValue) {
                selectPath(neighbour, accumulator + 1, stopValue, position, cb);
            } else {
                // the distance between neighbour.x neighbour.y and position.x position.y
                var distance = Math.pow(Math.pow(neighbour.x - position.x, 2) + Math.pow(neighbour.y - position.y, 2), 1/2);
                if(distance < 5) {
                    cb(neighbour);
                }
            }
        });
    }

    function drawPath(node) {
        graphics.lineStyle(1, 0xffffff, 1);
        node.neighbours.forEach(neighbour => {
            graphics.fillStyle(0xffffff, 1);
            graphics.lineBetween(neighbour.x, neighbour.y, node.x, node.y);
            graphics.fillCircle(neighbour.x, neighbour.y, 2);
            drawPath(neighbour);
        });
    }

    class Buggy extends Phaser.GameObjects.Sprite {
        constructor(config, location) {
            super(config.scene, config.x, config.y, 'buggy')
            //config.scene.add.sprite(config.x, config.y, "buggy").setInteractive()
            config.scene.add.existing(this);
            this.location = location;
            this.setInteractive();

            this.setScale(0.3);

            this.on('pointerdown', function (pointer) {
                this.setTint(0xff0000);
            });

            this.on('pointerup', function (pointer) {
                drawPath(this.location);
                traversePath(this.location, 1, diceRoll)
                movingBuggy = this;
            });
        }
    }
    </script>

</body>
</html>