<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
    <script type="text/javascript" src="src/paths.js"></script>
</head>
<body>

    <script>
    var config = {
        type: Phaser.AUTO,
            width: 768,
            height: 369,
        scene: {
            preload: preload,   
            create: create,
            update: update
        }
    };

    var game = new Phaser.Game(config);

    function preload ()
    {
        // load images
        this.load.image('background', 'assets/background.jpg');
        this.load.image('diceButton', 'assets/dicebutton.jpg');
        this.load.image('truckButton', 'assets/buytruck.jpg');
        this.load.image('popup', 'assets/pop.jpg');
        this.load.image('close', 'assets/close.jpg');
        this.load.image('buggy', 'assets/buggy.png');
    }

    
    var movingBuggy = null;
    var diceRoll = 0;
    var diceRollText;
    var baseNode = redMine;
    var money = 100;
    var moneyText;
    var truckNo = 6;
    var truckNoText;

    function create ()
    {
        var moonRocks = 0;

        let bg = this.add.sprite(0, 0, 'background');
        bg.setScale(0.4);
        bg.setOrigin(0,0);

        // the number of moon rocks you have
        var moonRocksText = this.add.text(670, 5, 'Moon Rocks: ' + moonRocks, { fontSize: '11px', fill: '#fff' });

        var truckNo = 6;
        var truckNoText = this.add.text(740, 21, truckNo, { fontSize: '11px', fill: '#fff' });
        moneyText = this.add.text(690, 60, 'Money ' + money, { fontSize: '11px', fill: '#fff' });

        // Add the roll dice button
        diceRollText = this.add.text(740, 41, '', { fontSize: '11px', fill: '#fff' });
        var rollDice = this.add.sprite(700, 46, 'diceButton').setInteractive();
        rollDice.setScale(0.3);
        rollDice.on('pointerdown', function (pointer) {
            this.setTint(0xff0000);
        });
        rollDice.on('pointerup', function (pointer) {
            rollDice.clearTint();
            moonRocksText.clearTint();
            truckNoText.clearTint();
            moneyText.clearTint();

            diceRoll = Math.floor(Math.random() * 6) + 1;
            diceRollText.setText(diceRoll);

            if(diceRoll == 6 || diceRoll == 1) {
                moonRocks = moonRocks + 1;
                moonRocksText.setText('Moon Rocks: ' + moonRocks);
                diceRoll = 0;
            }
        }.bind(this));

        // Add the truck buying button
        var buyTruck = this.add.sprite(700, 26, 'truckButton').setInteractive();
        buyTruck.setScale(0.3);
        buyTruck.on('pointerdown', function (pointer) {
            this.setTint(0xff0000);
        });
        buyTruck.on('pointerup', function (pointer) {
            buyTruck.clearTint();
            if(truckNo != 0 && moonRocks >= 2 && money >= 100) {
                truckNo = truckNo - 1;
                truckNoText.setText(truckNo);
                truckNoText.clearTint();

                moonRocks = moonRocks - 2;
                moonRocksText.setText('Moon Rocks: ' + moonRocks);

                money = money - 100;
                moneyText.setText('Money ' + money);

                // make a truck that has been bought
                var buggy = new Buggy({scene:this, x:baseNode.x, y:baseNode.y}, baseNode);
            } else if(truckNo == 0)  {
                truckNoText.setTint(0xff0000);
            } else if (moonRocks < 2) {
                moonRocksText.setTint(0xff0000);
            } else if (money < 100) {
                moneyText.setTint(0xff0000)
            }
        }.bind(this));
        
        // Iterate through each path and draw lines
        graphics = this.add.graphics();
        drawPath(pinkMine);
        drawPath(greenMine);
        drawPath(purpleMine);
        drawPath(blueMine);
        drawPath(redMine);
        drawPath(yellowMine);
    }

    function update() {
        // Record player mouse location if they can move the buggy move the buggy to the closest location
        this.input.on('pointerup', function (pointer) {
            if(movingBuggy) {
                if(diceRoll > 0) {
                    selectPath(movingBuggy.location, 1, diceRoll, pointer.position, clickedNode => {
                        movingBuggy.x = clickedNode.x;
                        movingBuggy.y = clickedNode.y;
                        movingBuggy.location = clickedNode;
                        diceRoll = 0;
                        diceRollText.setText('');
                        movingBuggy.clearTint();
                        movingBuggy = null;
                        drawPath(baseNode);
                    });
                } else {
                    movingBuggy.clearTint();
                    diceRollText.setText('');
                }
            }
        });
    }

    // Iterative function for looping through a path
    function traversePath(node, accumulator, stopValue) {
        node.neighbours.forEach(neighbour => {
            if(accumulator == stopValue || neighbour == newport) {
                graphics.fillStyle(0x000, 1);
                graphics.fillCircle(neighbour.x, neighbour.y, 2);
            } else {
                traversePath(neighbour, accumulator + 1, stopValue);
            }
        });
    }

    function selectPath(node, accumulator, stopValue, position, cb) {
        node.neighbours.forEach(neighbour => {
            if(accumulator == stopValue || neighbour == newport) {
                // the distance between neighbour.x neighbour.y and position.x position.y
                var distance = Math.pow(Math.pow(neighbour.x - position.x, 2) + Math.pow(neighbour.y - position.y, 2), 1/2);
                if(distance < 5) {
                    cb(neighbour);
                }
            } else {
                selectPath(neighbour, accumulator + 1, stopValue, position, cb);
            }
        });
    }

    function drawPath(node) {
        graphics.lineStyle(1, 0xffffff, 1);
        node.neighbours.forEach(neighbour => {
            graphics.fillStyle(0xffffff, 1);
            graphics.lineBetween(neighbour.x, neighbour.y, node.x, node.y);
            graphics.fillCircle(neighbour.x, neighbour.y, 2);
            drawPath(neighbour);
        });
    }

    class Buggy extends Phaser.GameObjects.Sprite {
        constructor(config, location) {
            super(config.scene, config.x, config.y, 'buggy')
            //config.scene.add.sprite(config.x, config.y, "buggy").setInteractive()
            config.scene.add.existing(this);
            this.location = location;
            this.setInteractive();

            this.setScale(0.3);

            this.on('pointerdown', function (pointer) {
                this.setTint(0xff0000);
            });

            this.on('pointerup', function (pointer) {
                if(this.location == newport) {
                    money = money + 100;
                    moneyText.setText('Money ' + money);
                    truckNo = truckNo + 1;
                    truckNoText.setText(truckNo);
                    this.destroy(true);
                } else {
                    drawPath(this.location);
                    traversePath(this.location, 1, diceRoll)
                    movingBuggy = this;
                }
            });
        }
    }
    </script>

</body>
</html>